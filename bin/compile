#!/bin/bash

env_dir=$3
whitelist_regex=${2:-'(FTP_HOST|FTP_USERNAME|FTP_PASSWORD)$'}
blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
if [ -d "$env_dir" ]; then
  for e in $(ls $env_dir); do
    echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
    export "$e=$(cat $env_dir/$e)"
    :
  done
fi


indent() {
  sed -u 's/^/       /'
}

echo "-----> Found a .vendor_urls file"

# Bail early but noisily
if [ ! -s $1/.vendor_urls ]; then
  echo ".vendor_urls empty. Skipping." | indent
  exit 0
fi

cd $1
while read url; do
  if [ -n "$url" ]; then # incase ensure_newline_at_eof_on_save is enabled
    eval echo Vendoring $url | indent
    eval curl -L --silent $url | tar xz
  fi
done < .vendor_urls
